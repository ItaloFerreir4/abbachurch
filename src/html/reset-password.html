<!DOCTYPE html>
<html lang="en" dir="ltr" data-nav-layout="vertical" data-vertical-style="overlay" data-theme-mode="dark" data-header-styles="dark" data-menu-styles="dark" data-toggled="close">

<head>

    <!-- Meta Data -->
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Entrar</title>
    <meta name="Description" content="Acessar o painel da Abba Church">
    <meta name="Author" content="Code+">
	<meta name="keywords" content="painel">

    <!-- Favicon -->
    <link rel="icon" href="../assets/images/brand-logos/fav.ico" type="image/x-icon">

    <!-- Main Theme Js -->
    <script src="../assets/js/authentication-main.js"></script>

    <!-- Bootstrap Css -->
    <link id="style" href="../assets/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet" >

    <!-- Style Css -->
    <link href="../assets/css/styles.min.css" rel="stylesheet" >

    <!-- Icons Css -->
    <link href="../assets/css/icons.min.css" rel="stylesheet" >


<link rel="stylesheet" href="../assets/libs/swiper/swiper-bundle.min.css">

<style>

.border-red, .border-red:focus, .border-red:hover {
    border: 1px solid red!important;
}

.border-green, .border-green:focus, .border-green:hover {
    border: 1px solid green!important;
}

</style>

</head>

<body class="bg-white">
    
    @SPK@include("partials/switcher.html")

    <div class="row mx-0 authentication">
        <div class="d-flex justify-content-center align-items-center d-lg-none">
            <a href="./"> <img src="../assets/images/brand-logos/desktop-dark.png" alt="Voltar" class="authentication-brand cover-dark-logo op-9"></a>  
        </div>
        <div class="col-xxl-6 col-xl-7 col-lg-12">
            <div class="row mx-0  justify-content-center align-items-center h-100">
                <div class="col-xxl-6 col-xl-7 col-lg-7 col-md-7 col-sm-8 col-12">
                    <div class="p-sm-5 p-0" style="padding-bottom: 0!important;"><div id="result-message"></div></div>
                    <div class="p-sm-5 p-0" style="display: none;" id="content-box">
                        <p class="h5 fw-semibold mb-1">Crie sua nova senha</p>
                        <div class="row gy-3 mt-1">
                            <div class="col-xl-12">
                                <label for="reset-newpassword" class="form-label text-default">Nova senha</label>
                                <div class="input-group">
                                    <input type="password" class="form-control form-control-lg" id="reset-newpassword" placeholder="*********" oninput="validarSenha()">
                                    <button aria-label="button" class="btn btn-light bg-transparent" onclick="createpassword('reset-newpassword',this)" type="button" id="button-addon21"><i class="ri-eye-off-line align-middle"></i></button>
                                </div>
                            </div>
                            <div class="col-xl-12 mb-3">
                                <label for="reset-confirmpassword" class="form-label text-default">Confirme a senha</label>
                                <div class="input-group">
                                    <input type="password" class="form-control form-control-lg" id="reset-confirmpassword" placeholder="*********" oninput="validarSenha()">
                                    <button aria-label="button" class="btn btn-light bg-transparent" onclick="createpassword('reset-confirmpassword',this)" type="button" id="button-addon22"><i class="ri-eye-off-line align-middle"></i></button>
                                </div>
                            </div>
                            <div class="col-xl-12 d-grid mt-1">
                                <button type="button" id="submitBtn" onclick="submitNewPass()" class="btn btn-lg btn-primary">Enviar</button>
                                <label class="mt-2">
                                    Lembrou a senha ?<a href="/login" class="text-primary ms-2 d-inline-block">Login</a>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-6 col-xl-5 col-lg-5 d-xl-block d-none px-0">
            <div class="authentication-cover">
                <div class="">
                    <div class="row justify-content-center g-0">
                        <div class="col-xl-9">
                            <a href="index.html"> <img src="../assets/images/brand-logos/desktop-dark.png" alt="" class="authentication-brand cover-dark-logo op-9"></a>                         
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom-Switcher JS -->
    <script src="../assets/js/custom-switcher.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="../assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Show Password JS -->
    <script src="../assets/js/show-password.js"></script>


    <script>

        window.addEventListener("load", function() {
            var url = window.location.href;
            var token = url.split("t=")[1];
            var result_message = document.getElementById("result-message");
            var content_box = document.getElementById("content-box");

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/recuperar-senha", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        result = JSON.parse(xhr.responseText);
                        if (result.sts === 1) {
                            content_box.style.display = "block";
                            result_message.innerHTML = '<div class="alert alert-success" role="alert">' + result.message + '</div>';
                        } else {
                            result_message.innerHTML = '<div class="alert alert-danger" role="alert">' + result.message + '</div>';
                        }
                    }
                }
            };
            xhr.send(JSON.stringify({token: token}));
            
        });

        function submitNewPass(){

            let senha = document.getElementById('reset-newpassword').value; console.log(senha);
            let confirmaSenha = document.getElementById('reset-confirmpassword').value;
            let result_message = document.getElementById('result-message');
            var content_box = document.getElementById("content-box");

            if ( senha.length < 5 || senha !== confirmaSenha ) {
                return false;
            }

            let url = window.location.href;
            let token = url.split("t=")[1];

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/nova-senha", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        result = JSON.parse(xhr.responseText);
                        if (result.sts === 1) {
                            content_box.style.display = "none";
                            result_message.innerHTML = '<div class="alert alert-success" role="alert">' + result.message + '</div><div>Pronto, tudo certo :). Agora s√≥ fazer o<a href="/login" class="text-primary ms-2 d-inline-block">Login</a> com sua nova senha.</div>';
                        } else {
                            content_box.style.display = "none";
                            result_message.innerHTML = '<div class="alert alert-danger" role="alert">' + result.message + '</div>';
                        }
                    }
                }
            };
            xhr.send(JSON.stringify({token: token, senha: senha}));
        }

        function validarSenha(){
            let senha = document.getElementById('reset-newpassword');
            let confirmaSenha = document.getElementById('reset-confirmpassword');
            let submitBtn = document.getElementById('submitBtn');

            if (senha.value.length < 5) {
                senha.classList.remove('border-red');
                confirmaSenha.classList.remove('border-red');
                senha.classList.remove('border-green');
                confirmaSenha.classList.remove('border-green');
                submitBtn.disabled = true;
            } else if (senha.value !== confirmaSenha.value) {
                senha.classList.remove('border-green');
                confirmaSenha.classList.remove('border-green');
                senha.classList.add('border-red');
                confirmaSenha.classList.add('border-red');
                submitBtn.disabled = true;
            } else {
                senha.classList.remove('border-red');
                confirmaSenha.classList.remove('border-red');
                senha.classList.add('border-green');
                confirmaSenha.classList.add('border-green');
                submitBtn.disabled = false;
            }
        }

    </script>

</body>

</html>