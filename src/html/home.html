@SPK@include("partials/mainhead.html")

@SPK@include("partials/fileupload_link.html")

<link rel="stylesheet" href="../assets/libs/fullcalendar/main.min.css">

</head>

<body>
    @SPK@include("partials/switcher.html")
    @SPK@include("partials/loader.html")

    <div class="page">
        @SPK@include("partials/header.html")
        @SPK@include("partials/sidebar.html")
        @SPK@include("partials/dashbord-page-header.html", {"dashbordtitle": "Calendario", "dashbordsubtitle": 'Dashboard' ,"dashbordsubtitle2": 'Calendario'})

        <!-- Start::app-content -->
        <div class="main-content app-content">
            <div class="container-fluid">
                <div class="row row-cols-xl-4 row-cols-md-2">
                    <div class="col card-background flex-fill">
                        <div class="card custom-card">
                            <div class="card-body">
                                <div class="d-flex">
                                    <div>
                                        <p class="fw-medium mb-1 text-muted">Total de Pastores</p>
                                        <h3 class="mb-0" id="qtdPastores"></h3>
                                    </div>
                                    <div class="avatar avatar-md br-4 bg-primary-transparent ms-auto"> <i class="bi bi-person"></i> </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col card-background flex-fill">
                        <div class="card custom-card">
                            <div class="card-body">
                                <div class="d-flex">
                                    <div>
                                        <p class="fw-medium mb-1 text-muted">Total de Lideres</p>
                                        <h3 class="mb-0" id="qtdLideres"></h3>
                                    </div>
                                    <div class="avatar avatar-md br-4 bg-primary-transparent ms-auto"> <i class="bi bi-person"></i> </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col card-background flex-fill">
                        <div class="card custom-card">
                            <div class="card-body">
                                <div class="d-flex">
                                    <div>
                                        <p class="fw-medium mb-1 text-muted">Total de Voluntarios</p>
                                        <h3 class="mb-0" id="qtdVoluntarios"></h3>
                                    </div>
                                    <div class="avatar avatar-md br-4 bg-primary-transparent ms-auto"> <i class="bi bi-person"></i> </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col card-background flex-fill">
                        <div class="card custom-card">
                            <div class="card-body">
                                <div class="d-flex">
                                    <div>
                                        <p class="fw-medium mb-1 text-muted">Total de Eventos</p>
                                        <h3 class="mb-0" id="qtdEventos"></h3>
                                    </div>
                                    <div class="avatar avatar-md br-4 bg-primary-transparent ms-auto"> <i class="bi bi-person"></i> </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card custom-card">
                    <div class="card-header align-center">
                        <h5 class="fw-medium mb-0 text-muted">Filtros</h5>
                        <div class="d-flex">
                            <button class="btn btn-filter btn-outline-primary btn-wave waves-effect waves-light ms-3" id="filter-todos" type="button" onClick="CalendarioFull(this)">Todos</button>
                            <button class="btn btn-filter btn-outline-primary btn-wave waves-effect waves-light ms-2" type="button" onClick="CalendarioNiver(this)">Aniversários</button>
                            <select class="btn btn-filter btn-outline-primary btn-wave waves-effect waves-light ms-2" id="filter-categoria" onChange="CalendarioCat(this)"></select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="calendario"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End::app-content -->

        @SPK@include("partials/headersearch_modal.html")
        @SPK@include("partials/footer.html")
        @SPK@include("partials/side-bar.html")

    </div>

    @SPK@include("partials/commonjs.html")

    @SPK@include("partials/custom_switcherjs.html")

    <!-- Fullcalendar JS -->
    <script src="../assets/libs/fullcalendar/main.min.js"></script>
    <!-- <script src="../assets/js/fullcalendar.js"></script> -->

    <!-- Custom JS -->
    <script src="../assets/js/custom.js"></script>

    <script>
        window.addEventListener("load", function() {
            const buttonTodos = document.getElementById("filter-todos");
            ListarCategorias();
            QtdPastores();
            QtdLideres();
            QtdVoluntarios();
            QtdEventos();
            CalendarioFull(buttonTodos);      
        });
        
        function CalendarioFull(button){

            TirarSelecaoBtn();
            button.classList.add("active");

            IniLoader();

            Promise.all([ListarEventos(), ListarPessoas()]).then(function ([dataEventos, dataPessoas]) {

                const idBirthday = dataEventos.length + 1;

                const dataCalendarBirthday = {
                    id: idBirthday,
                    backgroundColor: 'rgba(var(--teal-rgb), 0.4)',
                    borderColor: 'rgba(var(--teal-rgb), 1)',
                    textColor: '#fff',
                    events: dataPessoas
                }

                dataEventos.push(dataCalendarBirthday);

                const calendarEl = document.getElementById('calendario');
                let calendar = new FullCalendar.Calendar(calendarEl, {
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                    },
                    defaultView: 'month',
                    navLinks: true, // can click day/week names to navigate views
                    businessHours: true, // display business hours
                    editable: false,
                    selectable: false,
                    selectMirror: false,
                    droppable: false, // this allows things to be dropped onto the calendar

                    eventClick: function (arg) {
                        console.log('arg.event:', arg.event);
                        const description = arg.event.extendedProps.description;
                        Swal.fire({
                            position: 'center',
                            icon: 'info',
                            title: arg.event.title,
                            html:
                            'Data: ' + arg.event.start +
                            '<br> Descrição: ' + description,
                            showConfirmButton: true,
                        });
                    },

                    dayMaxEvents: true, // allow "more" link when too many events
                    eventSources: dataEventos,

                });
                calendar.render();

                FinLoader();
            });
        }
        
        function CalendarioNiver(button){
            TirarSelecaoBtn();
            button.classList.add("active");
            
            IniLoader();

            Promise.all([ListarEventosCat(2), ListarPessoas()]).then(function ([dataEventos, dataPessoas]) {

                const idBirthday = dataEventos.length + 1;

                const dataCalendarBirthday = {
                    id: idBirthday,
                    backgroundColor: 'rgba(var(--teal-rgb), 0.4)',
                    borderColor: 'rgba(var(--teal-rgb), 1)',
                    textColor: '#fff',
                    events: dataPessoas
                }

                dataEventos.push(dataCalendarBirthday);

                const calendarEl = document.getElementById('calendario');
                let calendar = new FullCalendar.Calendar(calendarEl, {
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                    },
                    defaultView: 'month',
                    navLinks: true, // can click day/week names to navigate views
                    businessHours: true, // display business hours
                    editable: false,
                    selectable: false,
                    selectMirror: false,
                    droppable: false, // this allows things to be dropped onto the calendar

                    eventClick: function (arg) {
                        console.log('arg.event:', arg.event);
                        const description = arg.event.extendedProps.description;
                        Swal.fire({
                            position: 'center',
                            icon: 'info',
                            title: arg.event.title,
                            html:
                            'Data: ' + arg.event.start +
                            '<br> Descrição: ' + description,
                            showConfirmButton: true,
                        });
                    },

                    dayMaxEvents: true, // allow "more" link when too many events
                    eventSources: dataEventos,

                });
                calendar.render();

                FinLoader();
            });
        }
        
        function CalendarioCat(button){
            TirarSelecaoBtn();
            button.classList.add("active");
            
            IniLoader();

            Promise.all([ListarEventosCat(button.value)]).then(function ([dataEventos]) {

                const calendarEl = document.getElementById('calendario');
                let calendar = new FullCalendar.Calendar(calendarEl, {
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                    },
                    defaultView: 'month',
                    navLinks: true, // can click day/week names to navigate views
                    businessHours: true, // display business hours
                    editable: false,
                    selectable: false,
                    selectMirror: false,
                    droppable: false, // this allows things to be dropped onto the calendar

                    eventClick: function (arg) {
                        console.log('arg.event:', arg.event);
                        const description = arg.event.extendedProps.description;
                        Swal.fire({
                            position: 'center',
                            icon: 'info',
                            title: arg.event.title,
                            html:
                            'Data: ' + arg.event.start +
                            '<br> Descrição: ' + description,
                            showConfirmButton: true,
                        });
                    },

                    dayMaxEvents: true, // allow "more" link when too many events
                    eventSources: dataEventos,

                });
                calendar.render();

                FinLoader();
            });
        }
        
        function ListarEventos() {
            return new Promise(function (resolve, reject) {

                let categoriasArrays = {};
                let countIdCat = 1;
                let countIdData = 1;
                let backgroundColor = '';
                let borderColor = '';

                // Usando uma Promise para esperar pela lista de líderes
                ListaMinisterios().then(function (listaMinisterios) {
                    $.post('api/listarEventos')
                        .done(function (data) {

                            data.forEach(function (evento) {
                                const idProcurado = evento.ministerioId;
                                const categoriaEventoId = evento.categoriaEventoId;
                                let nomeMinisterio = listaMinisterios.find(ministerio => ministerio.idMinisterio === idProcurado)?.nomeMinisterio;
                                nomeMinisterio = nomeMinisterio ? nomeMinisterio : 'Ministerio não encontrado!';

                                let dataInicioEvento = evento.dataHoraInicioEvento;
                                let dataFimEvento = evento.dataHoraFimEvento;
                                if (categoriaEventoId == 2) {
                                    dataInicioEvento = new Date(dataInicioEvento);
                                    dataInicioEvento = dataInicioEvento.toISOString().split('T')[0];
                                    dataFimEvento = new Date(dataInicioEvento);
                                    dataFimEvento = dataFimEvento.toISOString().split('T')[0];
                                }

                                if (categoriaEventoId) {
                                    if (!categoriasArrays[categoriaEventoId]) {
                                        backgroundColor = categoriaEventoId == 2 ? 'rgba(var(--teal-rgb), 0.4)' : 'rgba(var(--primary-rgb), 0.4)';
                                        borderColor = categoriaEventoId == 2 ? 'rgba(var(--teal-rgb), 1)' : 'rgba(var(--primary-rgb), 1)';
                                        categoriasArrays[categoriaEventoId] = {
                                            id: countIdCat,
                                            backgroundColor: backgroundColor,
                                            borderColor: borderColor,
                                            textColor: '#fff',
                                            events: []
                                        };
                                        countIdCat++;
                                    }

                                    categoriasArrays[categoriaEventoId].events.push({
                                        id: countIdData,
                                        start: dataInicioEvento,
                                        end: dataFimEvento,
                                        title: evento.nomeEvento,
                                        description: evento.observacoesEvento
                                    });

                                    countIdData++;
                                }
                            });
                            const arraysCategorias = Object.values(categoriasArrays);

                            resolve(arraysCategorias);
                        })
                        .fail(function (error) {
                            console.error('Erro na requisição:', error);
                            Swal.fire({
                                position: 'center',
                                icon: 'error',
                                title: 'Erro ao listar!',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            reject(error);
                        });
                });
        
            });
        }

        function ListarEventosCat(cat) {
            return new Promise(function (resolve, reject) {
                let categoriasArrays = {};
                let countIdCat = 1;
                let countIdData = 1;
                let backgroundColor = '';
                let borderColor = '';

                $.post('api/listarEventos')
                    .done(function (data) {
                        data.forEach(function (evento) {
                            const categoriaEventoId = evento.categoriaEventoId;
                            
                            if (categoriaEventoId == cat) {
                                let dataInicioEvento = evento.dataHoraInicioEvento;
                                let dataFimEvento = evento.dataHoraFimEvento;
                                if (categoriaEventoId == 2) {
                                    dataInicioEvento = new Date(dataInicioEvento);
                                    dataInicioEvento = dataInicioEvento.toISOString().split('T')[0];
                                    dataFimEvento = new Date(dataInicioEvento);
                                    dataFimEvento = dataFimEvento.toISOString().split('T')[0];
                                }

                                if (!categoriasArrays[categoriaEventoId]) {
                                    backgroundColor = categoriaEventoId == 2 ? 'rgba(var(--teal-rgb), 0.4)' : 'rgba(var(--primary-rgb), 0.4)';
                                    borderColor = categoriaEventoId == 2 ? 'rgba(var(--teal-rgb), 1)' : 'rgba(var(--primary-rgb), 1)';
                                    categoriasArrays[categoriaEventoId] = {
                                        id: countIdCat,
                                        backgroundColor: backgroundColor,
                                        borderColor: borderColor,
                                        textColor: '#fff',
                                        events: []
                                    };
                                    countIdCat++;
                                }

                                categoriasArrays[categoriaEventoId].events.push({
                                    id: countIdData,
                                    start: dataInicioEvento,
                                    end: dataFimEvento,
                                    title: evento.nomeEvento,
                                    description: evento.observacoesEvento
                                });

                                countIdData++;
                            }
                        });

                        const arraysCategorias = Object.values(categoriasArrays);
                        resolve(arraysCategorias);
                    })
                    .fail(function (error) {
                        console.error('Erro na requisição:', error);
                        Swal.fire({
                            position: 'center',
                            icon: 'error',
                            title: 'Erro ao listar!',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        reject(error);
                    });
            });
        }

        function ListaMinisterios() {
            return new Promise(function (resolve, reject) {

                $.post('api/listarMinisterios')
                    .done(function (data) {
                        resolve(data);
                    })
                    .fail(function (error) {
                        console.error('Erro na requisição:', error);
                        Swal.fire({
                            position: 'center',
                            icon: 'error',
                            title: 'Erro ao listar!',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        reject(error);
                    });
            });
        }
    
        function ListarPessoas(){
            return new Promise(function (resolve, reject) {
                
                let dataEvents = [];
                let count = 1;

                const formData = { tipoPessoa : 'todos' }

                $.post('api/listarPessoas', formData)
                    .done(function (data) {

                        data.forEach(function(pessoa) {

                            const nome = 'Aniversário de ' + pessoa.nomePessoa;
                            const description = 'Hoje ' + pessoa.nomePessoa + ' está fazendo aniversário';
                            const dataOld = pessoa.dataNascimentoPessoa;
                            let data = new Date(dataOld);

                            if (Object.prototype.toString.call(data) === '[object Date]' && !isNaN(data)) {
                                // const dataFormatada = data.toISOString().split('T')[0]; 
                                const dataFormatada = data.toISOString().split('T')[0];
                                data = dataFormatada;
                            } else {
                                data = dataOld;
                            }

                            dataEvents.push({ id: count, start: data, end: data, title: nome, description: description });

                            count ++;
                        });

                        resolve(dataEvents);
                    })
                    .fail(function (error) {
                        console.error('Erro na requisição:', error);
                        Swal.fire({
                            position: 'center',
                            icon: 'error',
                            title: 'Erro ao listar!',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        reject(error);
                    });
            });
        }
    
        function ListarCategorias(){

            const selectCat = $("#filter-categoria");

            selectCat.empty();
            selectCat.append(`<option value="">Selecione uma opção</option>`);

            $.post('api/listarCategoriasEventos')
                .done(function (data) {
                    data.forEach(function(categoria) {
                        if(categoria.idCategoriaEvento != 2){
                            selectCat.append(`<option value="${categoria.idCategoriaEvento}">${categoria.nomeCategoriaEvento}</option>`);
                        }
                    });
                })
                .fail(function (error) {
                    console.error('Erro na requisição:', error);
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'Erro ao listar!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                });
        }

        function QtdPastores(){
            const formData = { tipoPessoa : 'pastor' }
            const elementh3 = document.getElementById("qtdPastores");
            
            $.post('api/listarPessoas', formData)
                .done(function (data) {
                    if (Array.isArray(data)) {
                        elementh3.innerHTML = data.length;
                    } else {
                        elementh3.innerHTML = 'Sem dados.';
                    }
                })
                .fail(function (error) {
                    console.error('Erro na requisição:', error);
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'Erro ao listar!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                });
        }
    
        function QtdLideres(){
            const formData = { tipoPessoa : 'lider' }
            const elementh3 = document.getElementById("qtdLideres");
            
            $.post('api/listarPessoas', formData)
                .done(function (data) {
                    if (Array.isArray(data)) {
                        elementh3.innerHTML = data.length;
                    } else {
                        elementh3.innerHTML = 'Sem dados.';
                    }
                })
                .fail(function (error) {
                    console.error('Erro na requisição:', error);
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'Erro ao listar!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                });
        }

        function QtdVoluntarios(){
            const formData = { tipoPessoa : 'voluntario' }
            const elementh3 = document.getElementById("qtdVoluntarios");
            
            $.post('api/listarPessoas', formData)
                .done(function (data) {
                    if (Array.isArray(data)) {
                        elementh3.innerHTML = data.length;
                    } else {
                        elementh3.innerHTML = 'Sem dados.';
                    }
                })
                .fail(function (error) {
                    console.error('Erro na requisição:', error);
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'Erro ao listar!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                });
        }

        function QtdEventos(){
            const elementh3 = document.getElementById("qtdEventos");
            
            $.post('api/listarEventos')
                .done(function (data) {
                    if (Array.isArray(data)) {
                        elementh3.innerHTML = data.length;
                    } else {
                        elementh3.innerHTML = 'Sem dados.';
                    }
                })
                .fail(function (error) {
                    console.error('Erro na requisição:', error);
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'Erro ao listar!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                });
        }

        function TirarSelecaoBtn(){
            const btns = document.querySelectorAll(".btn-filter");

            btns.forEach(btn => {
                btn.classList.remove("active");
            });
        }
    </script>

</body>

</html>